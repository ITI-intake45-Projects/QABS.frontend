<div *ngIf="!isLoading" class="flex justify-center h-screen pb-10 overflow-y-auto flex-shrink-0">
  <div
    class="w-full max-w-4xl bg-[var(--background-primary)] overflow-y-auto shadow-2xl rounded-2xl border-2 border-[var(--gold-primary)] p-8 relative space-y-8">

    <!-- Title -->
    <h1 class="text-2xl font-bold text-[var(--green-dark)] text-center flex items-center justify-center gap-2">
      <i class="fa-solid fa-book-open text-[var(--gold-primary)]"></i>
      ุชุณุฌูู ุงุดุชุฑุงู ุฌุฏูุฏ
    </h1>

    <!-- Toast message -->
    <div *ngIf="showMessage" [ngClass]="{
           'bg-[var(--green-dark)]': messageType==='success',
           'bg-red-500': messageType==='error'
         }" class="text-white z-10 px-4 py-2 rounded-md absolute top-50 left-1/2 transform -translate-x-1/2 shadow-lg">
      {{ message }}
    </div>

    <form [formGroup]="enrollmentForm" (ngSubmit)="onSubmit()" class="space-y-6 bg-white rounded-lg p-6">

      <!-- Student & Teacher Dropdowns -->
      <div class="grid md:grid-cols-2 md:gap-6">
        <!-- Student -->
        <div>
          <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">ุงุฎุชุฑ ุงูุทุงูุจ<span
              class="text-red-500">*</span></label>
          <div class="relative">
            <button type="button" (click)="studentDropdownOpen = !studentDropdownOpen"
              class="w-full flex justify-between items-center px-4 py-2 border rounded-lg shadow-sm">
              <span>
                <ng-container *ngIf="selectedStudent; else noStudent">
                  <img [src]="selectedStudent.profileImg || 'assets/default-avatar.png'"
                    class="w-6 h-6 rounded-full inline-block mr-2 object-center">
                  {{ selectedStudent.fullName }}
                </ng-container>
                <ng-template #noStudent>ุงุฎุชุฑ ุงูุทุงูุจ</ng-template>
              </span>
              <i class="fa-solid fa-chevron-down ml-2"></i>
            </button>

            <div *ngIf="studentDropdownOpen"
              class="absolute z-10 mt-2 w-full bg-white rounded-lg shadow-lg max-h-60 overflow-y-auto">

              <!-- ๐ ูุฑุจุน ุงูุจุญุซ -->
              <div class="p-2">
                <input type="text" [(ngModel)]="studentSearchTerm" placeholder="ุงุจุญุซ ุนู ุงูุทุงูุจ..."
                  class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring focus:border-blue-300"
                  [ngModelOptions]="{standalone: true}" />

              </div>

              <!-- ุงููุงุฆูุฉ -->
              <div *ngFor="let s of students | filter: studentSearchTerm " (click)="selectStudent(s)"
                class="flex items-center px-4 py-2 cursor-pointer hover:bg-gray-100">
                <img [src]="s.profileImg || 'assets/default-avatar.png'"
                  class="w-8 h-8 rounded-full mr-2 object-cover ">
                {{ s.fullName }}
              </div>
            </div>
          </div>

        </div>

        <!-- Teacher -->
        <div>
          <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">ุงุฎุชุฑ ุงููุนูู<span
              class="text-red-500">*</span></label>
          <div class="relative">
            <button type="button" (click)="teacherDropdownOpen = !teacherDropdownOpen"
              class="w-full flex justify-between items-center px-4 py-2 border rounded-lg shadow-sm">
              <span>
                <ng-container *ngIf="selectedTeacher; else noTeacher">
                  <img [src]="selectedTeacher.profileImg || 'assets/default-avatar.png'"
                    class="w-6 h-6 rounded-full inline-block mr-2">
                  {{ selectedTeacher.fullName }}
                </ng-container>
                <ng-template #noTeacher>ุงุฎุชุฑ ุงููุนูู</ng-template>
              </span>
              <i class="fa-solid fa-chevron-down ml-2"></i>
            </button>

            <div *ngIf="teacherDropdownOpen"
              class="absolute z-10 mt-2 w-full bg-white rounded-lg shadow-lg max-h-60 overflow-y-auto">

              <!-- Search Box -->
              <div class="p-2">
                <input [(ngModel)]="teacherSearchTerm" type="text" placeholder="ุงุจุญุซ ุนู ูุนูู..."
                  class="w-full border rounded-lg px-3 py-1 text-sm outline-none"
                  [ngModelOptions]="{standalone: true}" />
              </div>

              <!-- Filtered List -->
              <div *ngFor="let t of teachers | filter:teacherSearchTerm" (click)="selectTeacher(t)"
                class="flex items-center px-4 py-2 cursor-pointer hover:bg-gray-100">
                <img [src]="t.profileImg || 'assets/default-avatar.png'" class="w-8 h-8 rounded-full mr-2 object-cover">
                {{ t.firstName }} {{ t.lastName }}
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Subscription Plan + Specialization -->
      <div class="grid md:grid-cols-2 md:gap-6">
        <div>
          <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">ุฎุทุฉ ุงูุงุดุชุฑุงู<span
              class="text-red-500">*</span></label>
          <select formControlName="SubscriptionPlanId"
            class="w-full px-4 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-[var(--gold-primary)] focus:border-[var(--gold-primary)]">
            <option value="" disabled selected>ุงุฎุชุฑ ุฎุทุฉ</option>
            <option *ngFor="let plan of subscriptionPlans" [value]="plan.id">{{ plan.name }}</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">ุงูุชุฎุตุต<span
              class="text-red-500">*</span></label>
          <select formControlName="Specialization" class="w-full px-4 py-2 border rounded-lg shadow-sm
         bg-[var(--background-primary)]
         text-[var(--text-primary)]
         border-[var(--green-dark)]
         focus:ring-2 focus:ring-[var(--gold-primary)] focus:border-[var(--gold-primary)]">

            <option class="bg-[var(--background-secondary)] text-[var(--text-primary)]" disabled selected>
              ุงุฎุชุฑ ุงูุชุฎุตุต
            </option>

            <option *ngFor="let spec of specializations" [value]="spec.id"
              class="bg-[var(--background-primary)] text-[var(--text-primary)] hover:bg-[var(--gold-secondary)]">
              {{ spec.label }}
            </option>
          </select>

        </div>
      </div>
      <!-- Days of Week Selection -->
      <div *ngIf="requiredDaysCount > 0">
        <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">
          ุงุฎุชุฑ {{ requiredDaysCount }} ููู/ุฃูุงู ูู ุงูุฃุณุจูุน<span class="text-red-500">*</span>
        </label>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
          <div *ngFor="let day of weekDays; let i = index">
            <label class="flex items-center space-x-2 cursor-pointer">
              <input type="checkbox" [value]="i" (change)="toggleDaySelection(i, $event)"
                [checked]="enrollmentForm.value.daysOfWeek.includes(i)"
                class="h-4 w-4 text-[var(--gold-primary)] border-gray-300 rounded focus:ring-[var(--gold-primary)]" />
              <span>{{ day }}</span>
            </label>
          </div>
        </div>
      </div>


      <!-- Start Time -->
      <div>
        <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">
          ููุช ุจุฏุงูุฉ ุงูุญุตุฉ <span class="text-red-500">*</span>
        </label>
        <input formControlName="startTime" type="time" class="w-full px-4 py-2 border rounded-lg shadow-sm
                focus:ring-2 focus:ring-[var(--gold-primary)]
                focus:border-[var(--gold-primary)]" />
      </div>

      <!-- <mat-form-field appearance="outline">
  <mat-label>ููุช ุจุฏุงูุฉ ุงูุญุตุฉ</mat-label>
  <input matInput [ngxTimepicker]="picker" formControlName="startTime" readonly>
  <ngx-material-timepicker #picker></ngx-material-timepicker>
</mat-form-field> -->



      <!-- Fee + Discount -->
      <div class="grid md:grid-cols-2 md:gap-6">
        <div>
          <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">ุงูุฑุณูู ุงูุดูุฑูุฉ<span
              class="text-red-500">*</span></label>
          <input formControlName="EnrollmentFee" type="number"
            class="w-full px-4 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-[var(--gold-primary)] focus:border-[var(--gold-primary)]">
        </div>
        <div>
          <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">ุงูุฎุตู</label>
          <input formControlName="Discount" type="number"
            class="w-full px-4 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-[var(--gold-primary)] focus:border-[var(--gold-primary)]" />
        </div>
      </div>

      <!-- Dates -->
      <div class="grid md:grid-cols-2 md:gap-6">
        <div>
          <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">ุชุงุฑูุฎ ุงูุจุฏุงูุฉ<span
              class="text-red-500">*</span></label>
          <input formControlName="StartDate" type="date"
            class="w-full px-4 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-[var(--gold-primary)] focus:border-[var(--gold-primary)]" />
        </div>
        <div>
          <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">ุชุงุฑูุฎ ุงูุงูุชูุงุก</label>
          <input formControlName="EndDate" type="date"
            class="w-full px-4 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-[var(--gold-primary)] focus:border-[var(--gold-primary)]" />
        </div>
      </div>

      <!-- Payment Section -->
      <div formGroupName="studentPayment" class="bg-gray-50 border p-4 rounded-lg shadow-sm space-y-4">
        <h2 class="text-lg font-semibold text-[var(--green-dark)] flex items-center gap-2">
          <i class="fa-solid fa-money-bill-wave text-[var(--gold-primary)]"></i> ุชูุงุตูู ุงูุฏูุน
        </h2>

        <div class="grid md:grid-cols-2 md:gap-6">
          <div>
            <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">ุงููุจูุบ ุงููุฏููุน<span
                class="text-red-500">*</span></label>
            <input formControlName="Amount" type="number"
              class="w-full px-4 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-[var(--gold-primary)] focus:border-[var(--gold-primary)]" />
          </div>
          <div>
            <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">ุชุงุฑูุฎ ุงูุฏูุน<span
                class="text-red-500">*</span></label>
            <input formControlName="PaymentDate" type="date"
              class="w-full px-4 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-[var(--gold-primary)] focus:border-[var(--gold-primary)]" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-[var(--text-primary)] mb-1">ุญุงูุฉ ุงูุฏูุน</label>
          <select formControlName="StudentPaymentStatus"
            class="w-full px-4 py-2 border rounded-lg shadow-sm focus:ring-2 focus:ring-[var(--gold-primary)] focus:border-[var(--gold-primary)]">
            <option *ngFor="let status of StudentPaymentStatus" [value]="status.id">{{ status.label }}</option>
          </select>
        </div>

        <div>
          <label class="block mb-2 text-sm font-medium text-gray-700">ุฅูุตุงู ุงูุฏูุน (ุงุฎุชูุงุฑู)</label>
          <input type="file" (change)="onFileChange($event)" accept="image/*"
            class="w-full px-3 py-2 border rounded-lg cursor-pointer bg-white shadow-sm" />
          <div *ngIf="previewUrl" class="mt-3">
            <img [src]="previewUrl" alt="preview" class="h-20 rounded shadow border" />
          </div>
        </div>
      </div>

      <!-- Submit -->
      <button type="submit" [disabled]="isLoadingsubmit"
        class="w-full h-12 bg-[var(--green-darker)] hover:bg-[var(--green-primary)] disabled:bg-gray-400 disabled:cursor-not-allowed text-white font-semibold py-2 px-4 rounded-lg shadow-md flex items-center justify-center gap-2">
        <ng-container *ngIf="!isLoading">ุชุณุฌูู ุงูุงุดุชุฑุงู</ng-container>
        <ng-container *ngIf="isLoading">
          <i class="fa-solid fa-spinner animate-spin"></i>
          <span>ุฌุงุฑู ุงูุชุญููู...</span>
        </ng-container>
      </button>
    </form>
  </div>
</div>



<!-- Loading State -->
<div *ngIf="isLoading" class="flex items-center justify-center h-screen bg-[var(--background-primary)]">
  <div class="text-center">
    <div
      class="inline-block animate-spin rounded-full h-16 w-16 border-4 border-[var(--green-primary)] border-t-transparent mb-4">
    </div>
    <p class="text-[var(--text-secondary)] text-lg font-medium">ุฌุงุฑู ุชุญููู ุงูุจูุงูุงุช...</p>
  </div>
</div>
